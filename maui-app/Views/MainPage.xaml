<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:UniteRev.Maui.ViewModels"
             x:Class="UniteRev.Maui.Views.MainPage"
             x:DataType="vm:MainViewModel"
             Title="Stream Viewer"
             BackgroundColor="{StaticResource BackgroundDark}">

    <Grid RowDefinitions="Auto,*,Auto" ColumnDefinitions="*,300">

        <!-- Top Bar -->
        <Grid Grid.Row="0" Grid.ColumnSpan="2"
              BackgroundColor="{StaticResource BackgroundMedium}"
              Padding="16,12" ColumnDefinitions="Auto,*,Auto,Auto">

            <Label Text="ðŸŽ¬ UniteRev" Style="{StaticResource Subtitle}" VerticalOptions="Center"/>

            <!-- URL Input -->
            <Frame Grid.Column="1" Style="{StaticResource Card}" Padding="4" Margin="16,0">
                <Grid ColumnDefinitions="*,Auto">
                    <Entry Style="{StaticResource FormEntry}"
                           Text="{Binding StreamUrlInput}"
                           Placeholder="Paste stream URL (Twitch, YouTube, Kick...)"
                           ReturnCommand="{Binding AddStreamCommand}"/>
                    <Button Grid.Column="1" Text="+ Add"
                            Style="{StaticResource PrimaryButton}"
                            Command="{Binding AddStreamCommand}"
                            Padding="12,8"/>
                </Grid>
            </Frame>

            <!-- Layout Picker -->
            <Picker Grid.Column="2"
                    ItemsSource="{Binding LayoutOptions}"
                    SelectedItem="{Binding GridLayout}"
                    Title="Layout"
                    TextColor="{StaticResource TextPrimary}"
                    TitleColor="{StaticResource TextSecondary}"
                    WidthRequest="100"/>

            <ActivityIndicator Grid.Column="3"
                               IsRunning="{Binding IsLoading}"
                               IsVisible="{Binding IsLoading}"
                               Color="{StaticResource Primary}"
                               WidthRequest="24" HeightRequest="24"
                               Margin="8,0,0,0"/>
        </Grid>

        <!-- Stream Grid -->
        <CollectionView Grid.Row="1" Grid.Column="0"
                        ItemsSource="{Binding GridCells}"
                        ItemsLayout="{Binding GridLayout, Converter={x:Null}}">
            <!-- Note: Grid layout is handled in code-behind for dynamic rows/cols -->
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:GridCellViewModel">
                    <Frame Style="{StaticResource Card}" Margin="4">
                        <Grid RowDefinitions="*,Auto">

                            <!-- Stream Content (WebView or Placeholder) -->
                            <Grid IsVisible="{Binding HasStream}">
                                <WebView Source="{Binding StreamUrl}"
                                         VerticalOptions="FillAndExpand"
                                         HorizontalOptions="FillAndExpand"/>
                            </Grid>

                            <!-- Empty Cell Placeholder -->
                            <VerticalStackLayout IsVisible="{Binding HasStream, Converter={StaticResource InvertedBoolConverter}}"
                                                 VerticalOptions="Center"
                                                 HorizontalOptions="Center"
                                                 Spacing="8">
                                <Label Text="ðŸ“º" FontSize="48" HorizontalOptions="Center"/>
                                <Label Text="{Binding DisplayLabel}"
                                       Style="{StaticResource Caption}"
                                       HorizontalOptions="Center"/>
                                <Label Text="Paste a URL above and click Add"
                                       Style="{StaticResource Caption}"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>

                            <!-- Cell Controls -->
                            <Grid Grid.Row="1" ColumnDefinitions="*,Auto,Auto,Auto"
                                  Padding="4" IsVisible="{Binding HasStream}">
                                <Label Text="{Binding DisplayLabel}"
                                       Style="{StaticResource Caption}"
                                       VerticalOptions="Center"
                                       LineBreakMode="TailTruncation"/>
                                <Button Grid.Column="1" Text="ðŸ”Š"
                                        Style="{StaticResource IconButton}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=ToggleAudioCommand}"
                                        CommandParameter="{Binding Position}"/>
                                <Button Grid.Column="2" Text="ðŸ’¾"
                                        Style="{StaticResource IconButton}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=SaveCurrentAsStreamerCommand}"
                                        CommandParameter="{Binding Position}"/>
                                <Button Grid.Column="3" Text="âœ•"
                                        Style="{StaticResource IconButton}"
                                        TextColor="{StaticResource Danger}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=RemoveStreamCommand}"
                                        CommandParameter="{Binding Position}"/>
                            </Grid>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Sidebar: Saved Streamers -->
        <Grid Grid.Row="1" Grid.Column="1" BackgroundColor="{StaticResource BackgroundMedium}">
            <Grid RowDefinitions="Auto,*" Padding="12">

                <VerticalStackLayout Grid.Row="0" Spacing="8">
                    <Label Text="ðŸ’¾ Saved Streamers" Style="{StaticResource Subtitle}" FontSize="16"/>
                    <Button Text="Check Who's Live"
                            Style="{StaticResource SecondaryButton}"
                            Command="{Binding CheckSavedStreamersLiveCommand}"/>
                    <BoxView HeightRequest="1" Color="{StaticResource BorderDark}" Margin="0,4"/>
                </VerticalStackLayout>

                <CollectionView Grid.Row="1"
                                ItemsSource="{Binding SavedStreamers}"
                                Margin="0,8,0,0">
                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="16">
                            <Label Text="No saved streamers" Style="{StaticResource Caption}"
                                   HorizontalOptions="Center"/>
                            <Label Text="Save streamers using the ðŸ’¾ button"
                                   Style="{StaticResource Caption}"
                                   HorizontalOptions="Center" Margin="0,4,0,0"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:MainViewModel">
                            <!-- Streamer items bound in code-behind due to model type -->
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </Grid>

        <!-- Bottom Status Bar -->
        <Grid Grid.Row="2" Grid.ColumnSpan="2"
              BackgroundColor="{StaticResource BackgroundMedium}"
              Padding="16,8" ColumnDefinitions="*,Auto">
            <Label Text="{Binding GridLayout, StringFormat='Layout: {0}'}"
                   Style="{StaticResource Caption}" VerticalOptions="Center"/>
            <Label Grid.Column="1"
                   Text="{Binding SavedStreamers.Count, StringFormat='{0} saved streamers'}"
                   Style="{StaticResource Caption}" VerticalOptions="Center"/>
        </Grid>
    </Grid>

</ContentPage>
