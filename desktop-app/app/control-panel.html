<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        body.custom-bg {
            background: var(--custom-bg, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
        }

        .main-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 40px);
        }

        .container {
            /* Legacy container - will be replaced by floating panels */
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 12px;
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        /* Floating Panel System */
        .floating-panel {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            min-width: 300px;
            max-width: 800px;
            max-height: calc(100vh - 80px);
            z-index: 1;
            transition: box-shadow 0.2s;
        }

        .floating-panel:hover {
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
        }

        .floating-panel.active {
            z-index: 100;
        }

        .floating-panel.minimized {
            height: auto !important;
            max-height: none !important;
        }

        .floating-panel.minimized .panel-content {
            display: none;
        }

        .panel-header {
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px 16px 0 0;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            color: white;
        }

        .panel-header.custom-color {
            background: var(--panel-color, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
        }

        .panel-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-controls {
            display: flex;
            gap: 8px;
        }

        .panel-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .panel-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .panel-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            color: #1E293B;
        }

        .panel-content::-webkit-scrollbar {
            width: 6px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .card {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: none;
            color: #1E293B;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1E293B;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #475569;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            color: #1E293B;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-help {
            font-size: 12px;
            color: #64748B;
            margin-top: 6px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            font-size: 14px;
            color: #475569;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
            justify-content: center;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #E2E8F0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #CBD5E1;
        }

        .btn-danger {
            background: #EF4444;
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .saved-streamers-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .streamer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #F8FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .streamer-item:hover {
            border-color: #667eea;
            transform: translateX(4px);
        }

        .streamer-info {
            flex: 1;
            min-width: 0;
            margin-right: 12px;
        }

        .streamer-name {
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .streamer-name:hover {
            color: #667eea;
            text-decoration: underline;
        }

        .streamer-meta {
            font-size: 12px;
            color: #64748B;
            text-transform: capitalize;
        }

        .streamer-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .stream-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #F8FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .stream-item:hover {
            border-color: #667eea;
            transform: translateX(4px);
        }

        .stream-info {
            flex: 1;
            min-width: 0;
            margin-right: 12px;
        }

        .stream-name {
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 4px;
        }

        .stream-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748B;
        }

        /* Logo Customization */
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logo-container:hover {
            background: rgba(102, 126, 234, 0.15);
        }

        .logo-display {
            width: 120px;
            height: 120px;
            margin: 0 auto 12px;
            border-radius: 12px;
            object-fit: cover;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .logo-upload-btn {
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
        }

        /* Color Customization */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .color-option {
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .color-option:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .color-option.active {
            border-color: white;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
        }

        .color-option.active::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Panel Toggle Sidebar */
        .panel-toggle-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 10000;
            overflow-y: auto;
        }

        .panel-toggle-sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            color: white;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-toggle-btn {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 12px 8px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            z-index: 9999;
            font-size: 18px;
            transition: all 0.2s;
        }

        .sidebar-toggle-btn:hover {
            background: rgba(102, 126, 234, 0.9);
            padding-left: 12px;
        }

        .panel-toggle-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .panel-toggle-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .panel-toggle-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .panel-toggle-item label {
            color: white;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }

        /* Panel Resize Handles */
        .panel-resize-handle {
            position: absolute;
            z-index: 10;
        }

        .panel-resize-handle.n {
            top: 0;
            left: 10px;
            right: 10px;
            height: 5px;
            cursor: ns-resize;
        }

        .panel-resize-handle.s {
            bottom: 0;
            left: 10px;
            right: 10px;
            height: 5px;
            cursor: ns-resize;
        }

        .panel-resize-handle.e {
            right: 0;
            top: 10px;
            bottom: 10px;
            width: 5px;
            cursor: ew-resize;
        }

        .panel-resize-handle.w {
            left: 0;
            top: 10px;
            bottom: 10px;
            width: 5px;
            cursor: ew-resize;
        }

        .panel-resize-handle.ne {
            top: 0;
            right: 0;
            width: 15px;
            height: 15px;
            cursor: nesw-resize;
        }

        .panel-resize-handle.nw {
            top: 0;
            left: 0;
            width: 15px;
            height: 15px;
            cursor: nwse-resize;
        }

        .panel-resize-handle.se {
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            cursor: nwse-resize;
        }

        .panel-resize-handle.sw {
            bottom: 0;
            left: 0;
            width: 15px;
            height: 15px;
            cursor: nesw-resize;
        }

        .floating-panel.resizing {
            opacity: 0.9;
        }

        /* Unified Chat Panel */
        .chat-panel {
            /* Will be converted to floating panel */
        }

        .chat-header {
            margin-bottom: 16px;
        }

        .chat-title {
            font-size: 24px;
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 12px;
        }

        .chat-logins {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .login-btn {
            padding: 8px 16px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            background: white;
            color: #475569;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .login-btn:hover {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .login-btn.connected {
            border-color: #10B981;
            background: #10B981;
            color: white;
        }

        .login-btn.connected:hover {
            background: #059669;
        }

        .platform-badge {
            font-size: 16px;
        }

        .chat-feed {
            flex: 1;
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            padding: 16px;
            overflow-y: auto;
            min-height: 400px;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 6px;
            background: #F8FAFC;
            border-left: 3px solid #CBD5E1;
        }

        .chat-message.twitch {
            border-left-color: #9146FF;
        }

        .chat-message.youtube {
            border-left-color: #FF0000;
        }

        .chat-message.twitter {
            border-left-color: #1DA1F2;
        }

        .chat-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .chat-platform {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            background: #CBD5E1;
            color: #475569;
        }

        .chat-platform.twitch {
            background: #9146FF;
            color: white;
        }

        .chat-platform.youtube {
            background: #FF0000;
            color: white;
        }

        .chat-platform.twitter {
            background: #1DA1F2;
            color: white;
        }

        .chat-username {
            font-weight: 600;
            color: #1E293B;
            font-size: 13px;
        }

        .chat-timestamp {
            font-size: 11px;
            color: #94A3B8;
            margin-left: auto;
        }

        .chat-text {
            color: #475569;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .chat-status {
            padding: 12px;
            background: #FEF3C7;
            border: 1px solid #FCD34D;
            border-radius: 6px;
            color: #92400E;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .chat-status.connected {
            background: #D1FAE5;
            border-color: #6EE7B7;
            color: #065F46;
        }

        .chat-empty {
            text-align: center;
            padding: 40px 20px;
            color: #94A3B8;
        }

        .chat-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .grid-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .grid-btn {
            padding: 12px;
            background: #F8FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            color: #475569;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .grid-btn:hover {
            border-color: #667eea;
            background: white;
        }

        .grid-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            color: #1E293B;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .pulse {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10B981;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #E2E8F0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <input type="file" id="logoUploadInput" accept="image/*" style="display: none;">

    <!-- Panel Toggle Sidebar -->
    <button class="sidebar-toggle-btn" onclick="panelManager.toggleSidebar()">‚ò∞</button>
    <div class="panel-toggle-sidebar" id="panelSidebar">
        <div class="sidebar-header">üìã Panel Manager</div>
        <div id="panelToggleList"></div>
    </div>

    <div class="main-container">
        <!-- Logo Header Panel -->
        <div class="floating-panel minimized" id="logoPanel" style="left: 20px; top: 20px; width: 300px;">
            <div class="panel-header">
                <div class="panel-title">
                    <span id="headerLogoDisplay">üö©</span>
                    <span>Control Panel</span>
                </div>
                <div class="panel-controls">
                    <button class="panel-btn" onclick="panelManager.minimizePanel('logoPanel')" title="Minimize">‚àí</button>
                    <button class="panel-btn" onclick="panelManager.closePanel('logoPanel')" title="Close">‚úï</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="logo-container" onclick="document.getElementById('logoUploadInput').click()">
                    <div class="logo-display" id="logoDisplay">üö©</div>
                    <div class="logo-upload-btn">Click to upload custom logo</div>
                </div>
                <div class="status-bar">
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span>Connected to Viewer</span>
                    </div>
                </div>

                <div id="scannerButtonContainer" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.1); display: none;">
                    <button class="btn btn-primary" onclick="window.open('scanner.html', 'StreamScanner', 'width=1400,height=900')" style="width: 100%;">
                        üîç Open Stream Scanner
                    </button>
                    <div style="font-size: 12px; color: #64748B; margin-top: 8px; text-align: center;">
                        Find streams by keywords & trending topics
                    </div>
                </div>
            </div>
        </div>

        <!-- Customization Panel -->
        <div class="floating-panel minimized" id="customizePanel" style="left: 20px; top: 80px; width: 320px;">
            <div class="panel-header">
                <div class="panel-title">üé® Customize</div>
                <div class="panel-controls">
                    <button class="panel-btn" onclick="panelManager.minimizePanel('customizePanel')" title="Minimize">‚àí</button>
                    <button class="panel-btn" onclick="panelManager.closePanel('customizePanel')" title="Close">‚úï</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="card">
                    <h3 class="card-title" style="font-size: 16px; margin-bottom: 12px;">Background Theme</h3>
                    <div class="color-grid" id="bgColorGrid"></div>
                </div>
                <div class="card">
                    <h3 class="card-title" style="font-size: 16px; margin-bottom: 12px;">Panel Color</h3>
                    <div class="color-grid" id="panelColorGrid"></div>
                </div>
                <button class="btn btn-secondary" onclick="panelManager.resetCustomization()" style="width: 100%; margin-top: 12px;">
                    Reset to Default
                </button>
            </div>
        </div>

        <!-- Add Stream Panel -->
        <div class="floating-panel minimized" id="addStreamPanel" style="left: 20px; top: 140px; width: 400px;">
            <div class="panel-header">
                <div class="panel-title">‚ûï Add Stream</div>
                <div class="panel-controls">
                    <button class="panel-btn" onclick="panelManager.minimizePanel('addStreamPanel')" title="Minimize">‚àí</button>
                    <button class="panel-btn" onclick="panelManager.closePanel('addStreamPanel')" title="Close">‚úï</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="card">

            <div class="form-group">
                <label class="form-label">Stream Name</label>
                <input type="text" class="form-input" id="streamName" placeholder="e.g., Breaking News Stream">
            </div>

            <div class="form-group">
                <label class="form-label">Stream URL</label>
                <input type="url" class="form-input" id="streamUrl" placeholder="https://www.youtube.com/watch?v=...">
                <div class="form-help">
                    Supports: YouTube, Twitch, X (Twitter), TikTok, Facebook Live, Rumble
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="saveStreamer" checked>
                    <label for="saveStreamer">Save streamer to my list for later</label>
                </div>
                <div class="form-help">
                    Saves the streamer/channel info for quick access
                </div>
            </div>

            <button class="btn btn-primary" onclick="controlPanel.addStream()">
                <span>‚ûï</span>
                <span>Add to Viewer</span>
            </button>
                </div>
            </div>
        </div>

        <!-- Grid Layout Panel -->
        <div class="floating-panel minimized" id="gridPanel" style="left: 20px; top: 200px; width: 350px;">
            <div class="panel-header">
                <div class="panel-title">üìê Grid Layout</div>
                <div class="panel-controls">
                    <button class="panel-btn" onclick="panelManager.minimizePanel('gridPanel')" title="Minimize">‚àí</button>
                    <button class="panel-btn" onclick="panelManager.closePanel('gridPanel')" title="Close">‚úï</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="grid-selector" id="layoutSelector"></div>
            </div>
        </div>

        <!-- Saved Streamers Panel -->
        <div class="floating-panel minimized" id="streamersPanel" style="left: 20px; top: 260px; width: 450px;">
            <div class="panel-header">
                <div class="panel-title">üíæ Saved Streamers</div>
                <div class="panel-controls">
                    <button class="panel-btn" onclick="panelManager.minimizePanel('streamersPanel')" title="Minimize">‚àí</button>
                    <button class="panel-btn" onclick="panelManager.closePanel('streamersPanel')" title="Close">‚úï</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="saved-streamers-list" id="savedStreamersList"></div>
            </div>
        </div>

        <!-- Audio Control Panel -->
        <div class="floating-panel minimized" id="audioPanel" style="left: 20px; top: 320px; width: 400px;">
            <div class="panel-header">
                <div class="panel-title">üîä Audio Control</div>
                <div class="panel-controls">
                    <button class="panel-btn" onclick="panelManager.minimizePanel('audioPanel')" title="Minimize">‚àí</button>
                    <button class="panel-btn" onclick="panelManager.closePanel('audioPanel')" title="Close">‚úï</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="form-help" style="margin-bottom: 12px;">
                    Click to switch audio source (only one stream plays audio at a time)
                </div>
                <div id="audioControlList"></div>
            </div>
        </div>

        <!-- Quick Actions Panel -->
        <div class="floating-panel minimized" id="actionsPanel" style="left: 20px; top: 380px; width: 300px;">
            <div class="panel-header">
                <div class="panel-title">‚ö° Quick Actions</div>
                <div class="panel-controls">
                    <button class="panel-btn" onclick="panelManager.minimizePanel('actionsPanel')" title="Minimize">‚àí</button>
                    <button class="panel-btn" onclick="panelManager.closePanel('actionsPanel')" title="Close">‚úï</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="controlPanel.clearAllStreams()">
                        üóëÔ∏è Clear All
                    </button>
                    <button class="btn btn-secondary" onclick="controlPanel.refreshViewer()">
                        üîÑ Refresh Viewer
                    </button>
                </div>
            </div>
        </div>

        <!-- Unified Chat Panel -->
        <div class="floating-panel minimized" id="chatPanel" style="left: 20px; top: 440px; width: 500px; height: 600px;">
            <div class="panel-header">
                <div class="panel-title">üí¨ Unified Chat</div>
                <div class="panel-controls">
                    <button class="panel-btn" onclick="panelManager.minimizePanel('chatPanel')" title="Minimize">‚àí</button>
                    <button class="panel-btn" onclick="panelManager.closePanel('chatPanel')" title="Close">‚úï</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="chat-header">
                    <div class="chat-logins">
                        <button class="login-btn" id="twitchLoginBtn" onclick="chatManager.loginTwitch()">
                            <span class="platform-badge">üíú</span>
                            <span id="twitchLoginText">Login Twitch</span>
                        </button>
                        <button class="login-btn" id="youtubeLoginBtn" onclick="chatManager.loginYouTube()">
                            <span class="platform-badge">‚ñ∂Ô∏è</span>
                            <span id="youtubeLoginText">Login YouTube</span>
                        </button>
                    </div>

                    <div id="chatStatus"></div>
                </div>

                <div class="chat-feed" id="chatFeed">
                    <div class="chat-empty">
                        <div class="chat-empty-icon">üí¨</div>
                        <div>Login to platforms to see unified chat</div>
                        <div style="font-size: 12px; margin-top: 8px;">All platform chats will appear here in real-time</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stream Overlays & Alerts Panel -->
        <div class="floating-panel minimized" id="overlaysPanel" style="left: 20px; top: 500px; width: 500px;">
            <div class="panel-header">
                <div class="panel-title">‚ú® Stream Overlays & Alerts</div>
                <div class="panel-controls">
                    <button class="panel-btn" onclick="panelManager.minimizePanel('overlaysPanel')" title="Minimize">‚àí</button>
                    <button class="panel-btn" onclick="panelManager.closePanel('overlaysPanel')" title="Close">‚úï</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="card">
                    <h3 class="card-title" style="font-size: 16px; margin-bottom: 12px;">Browser Source URL</h3>
                    <div class="form-group">
                        <label class="form-label">Overlay URL (for OBS/Streamlabs)</label>
                        <input type="text" class="form-input" id="overlayUrl" readonly
                               placeholder="Will generate after configuring alerts">
                        <button class="btn btn-secondary" onclick="overlayManager.copyOverlayUrl()" style="margin-top: 8px; width: 100%;">
                            üìã Copy URL
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title" style="font-size: 16px; margin-bottom: 12px;">Alert Configuration</h3>

                    <div class="form-group">
                        <label class="form-label">Alert Type</label>
                        <select class="form-input" id="alertType">
                            <option value="follow">New Follower</option>
                            <option value="subscribe">New Subscriber</option>
                            <option value="donation">Donation/Tip</option>
                            <option value="raid">Raid Alert</option>
                            <option value="host">Host Alert</option>
                            <option value="bits">Bits/Cheer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Alert Text Template</label>
                        <input type="text" class="form-input" id="alertText"
                               placeholder="e.g., {username} just followed!">
                        <div class="form-help">
                            Use {username}, {amount}, {message} as placeholders
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Duration (seconds)</label>
                        <input type="number" class="form-input" id="alertDuration"
                               value="5" min="1" max="30">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Alert Sound (optional)</label>
                        <input type="file" class="form-input" id="alertSound" accept="audio/*">
                        <div class="form-help">Upload MP3, WAV, or OGG</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Text Color</label>
                        <input type="color" class="form-input" id="alertColor" value="#ffffff">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Animation</label>
                        <select class="form-input" id="alertAnimation">
                            <option value="fade">Fade In/Out</option>
                            <option value="slide">Slide In</option>
                            <option value="bounce">Bounce</option>
                            <option value="zoom">Zoom</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="overlayManager.saveAlertConfig()" style="width: 100%;">
                        üíæ Save Alert Config
                    </button>
                </div>

                <div class="card">
                    <h3 class="card-title" style="font-size: 16px; margin-bottom: 12px;">Test Alert</h3>
                    <button class="btn btn-secondary" onclick="overlayManager.testAlert()" style="width: 100%;">
                        üé¨ Preview Alert
                    </button>
                </div>

                <div class="card">
                    <h3 class="card-title" style="font-size: 16px; margin-bottom: 12px;">Integration</h3>
                    <div class="form-help" style="margin-bottom: 12px;">
                        Add this URL as a Browser Source in OBS/Streamlabs OBS:
                    </div>
                    <ol style="font-size: 13px; color: #64748B; padding-left: 20px;">
                        <li>Copy the overlay URL above</li>
                        <li>In OBS: Sources ‚Üí Add ‚Üí Browser</li>
                        <li>Paste the URL</li>
                        <li>Set width: 1920, height: 1080</li>
                        <li>Check "Shutdown source when not visible"</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Twitch IRC Library -->
    <script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>

    <!-- Scanner Configuration -->
    <script src="scanner-config.js"></script>

    <script>
        // Panel Manager - handles dragging, minimizing, customization
        const panelManager = {
            draggingPanel: null,
            resizingPanel: null,
            resizeDirection: null,
            offset: { x: 0, y: 0 },
            highestZ: 100,
            sidebarOpen: false,
            panels: [
                { id: 'logoPanel', name: 'üö© Logo & Status', visible: true },
                { id: 'customizePanel', name: 'üé® Customize', visible: true },
                { id: 'addStreamPanel', name: '‚ûï Add Stream', visible: true },
                { id: 'gridPanel', name: 'üìê Grid Layout', visible: true },
                { id: 'streamersPanel', name: 'üíæ Saved Streamers', visible: true },
                { id: 'audioPanel', name: 'üîä Audio Control', visible: true },
                { id: 'actionsPanel', name: '‚ö° Quick Actions', visible: true },
                { id: 'chatPanel', name: 'üí¨ Unified Chat', visible: true },
                { id: 'overlaysPanel', name: '‚ú® Stream Overlays & Alerts', visible: true }
            ],
            customization: {
                bgTheme: 'default',
                panelColor: 'default',
                logoUrl: null
            },

            init() {
                this.loadCustomization();
                this.loadPanelVisibility();
                this.initPanelDragging();
                this.initPanelResizing();
                this.initLogoUpload();
                this.renderColorOptions();
                this.renderPanelToggles();
                this.applyCustomization();
                this.updatePanelVisibility();

                // Make panels clickable to bring to front
                document.querySelectorAll('.floating-panel').forEach(panel => {
                    panel.addEventListener('mousedown', () => this.bringToFront(panel));
                });

                // Close sidebar when clicking outside
                document.addEventListener('click', (e) => {
                    const sidebar = document.getElementById('panelSidebar');
                    const toggleBtn = document.querySelector('.sidebar-toggle-btn');
                    if (this.sidebarOpen && !sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
                        this.toggleSidebar();
                    }
                });
            },

            initPanelDragging() {
                document.querySelectorAll('.panel-header').forEach(header => {
                    header.addEventListener('mousedown', (e) => this.startDrag(e));
                });

                document.addEventListener('mousemove', (e) => this.drag(e));
                document.addEventListener('mouseup', () => this.stopDrag());
            },

            startDrag(e) {
                const panel = e.target.closest('.floating-panel');
                if (!panel || e.target.closest('.panel-btn')) return;

                this.draggingPanel = panel;
                this.bringToFront(panel);

                const rect = panel.getBoundingClientRect();
                this.offset.x = e.clientX - rect.left;
                this.offset.y = e.clientY - rect.top;

                panel.style.cursor = 'grabbing';
                e.preventDefault();
            },

            drag(e) {
                if (!this.draggingPanel) return;

                let x = e.clientX - this.offset.x;
                let y = e.clientY - this.offset.y;

                // Keep within viewport
                const rect = this.draggingPanel.getBoundingClientRect();
                const maxX = window.innerWidth - rect.width;
                const maxY = window.innerHeight - rect.height;

                x = Math.max(0, Math.min(x, maxX));
                y = Math.max(0, Math.min(y, maxY));

                this.draggingPanel.style.left = x + 'px';
                this.draggingPanel.style.top = y + 'px';
                this.draggingPanel.style.right = 'auto';
                this.draggingPanel.style.bottom = 'auto';

                this.savePanelPositions();
            },

            stopDrag() {
                if (this.draggingPanel) {
                    this.draggingPanel.style.cursor = '';
                    this.draggingPanel = null;
                }
            },

            bringToFront(panel) {
                this.highestZ++;
                panel.style.zIndex = this.highestZ;
                document.querySelectorAll('.floating-panel').forEach(p => p.classList.remove('active'));
                panel.classList.add('active');
            },

            minimizePanel(panelId) {
                const panel = document.getElementById(panelId);
                const isMinimized = panel.classList.toggle('minimized');
                const btns = panel.querySelectorAll('.panel-controls .panel-btn');
                btns[0].textContent = isMinimized ? '+' : '‚àí';
                btns[0].title = isMinimized ? 'Maximize' : 'Minimize';
                this.savePanelPositions();
            },

            closePanel(panelId) {
                const panel = document.getElementById(panelId);
                panel.style.display = 'none';

                // Update panel visibility state
                const panelConfig = this.panels.find(p => p.id === panelId);
                if (panelConfig) {
                    panelConfig.visible = false;
                    this.savePanelVisibility();
                    this.renderPanelToggles();
                }
            },

            initLogoUpload() {
                const input = document.getElementById('logoUploadInput');
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const logoUrl = e.target.result;
                            this.customization.logoUrl = logoUrl;
                            this.updateLogo(logoUrl);
                            this.saveCustomization();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            },

            updateLogo(url) {
                const logoDisplay = document.getElementById('logoDisplay');
                const headerLogo = document.getElementById('headerLogoDisplay');

                if (url) {
                    logoDisplay.innerHTML = `<img src="${url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">`;
                    headerLogo.innerHTML = `<img src="${url}" style="width: 24px; height: 24px; object-fit: cover; border-radius: 4px;">`;
                } else {
                    logoDisplay.innerHTML = 'üö©';
                    headerLogo.innerHTML = 'üö©';
                }
            },

            renderColorOptions() {
                const bgThemes = [
                    { id: 'default', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                    { id: 'sunset', gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
                    { id: 'ocean', gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
                    { id: 'forest', gradient: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' },
                    { id: 'night', gradient: 'linear-gradient(135deg, #2c3e50 0%, #3498db 100%)' },
                    { id: 'fire', gradient: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' }
                ];

                const panelColors = [
                    { id: 'default', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                    { id: 'red', gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
                    { id: 'blue', gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
                    { id: 'green', gradient: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' },
                    { id: 'dark', gradient: 'linear-gradient(135deg, #2c3e50 0%, #4a5568 100%)' },
                    { id: 'gold', gradient: 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)' }
                ];

                document.getElementById('bgColorGrid').innerHTML = bgThemes.map(theme => `
                    <div class="color-option ${this.customization.bgTheme === theme.id ? 'active' : ''}"
                         style="background: ${theme.gradient}"
                         onclick="panelManager.setBgTheme('${theme.id}', '${theme.gradient}')">
                    </div>
                `).join('');

                document.getElementById('panelColorGrid').innerHTML = panelColors.map(color => `
                    <div class="color-option ${this.customization.panelColor === color.id ? 'active' : ''}"
                         style="background: ${color.gradient}"
                         onclick="panelManager.setPanelColor('${color.id}', '${color.gradient}')">
                    </div>
                `).join('');
            },

            setBgTheme(id, gradient) {
                this.customization.bgTheme = id;
                this.customization.bgGradient = gradient;
                document.body.style.background = gradient;
                this.renderColorOptions();
                this.saveCustomization();
            },

            setPanelColor(id, gradient) {
                this.customization.panelColor = id;
                this.customization.panelGradient = gradient;
                document.querySelectorAll('.panel-header').forEach(header => {
                    header.style.background = gradient;
                });
                this.renderColorOptions();
                this.saveCustomization();
            },

            applyCustomization() {
                if (this.customization.bgGradient) {
                    document.body.style.background = this.customization.bgGradient;
                }
                if (this.customization.panelGradient) {
                    document.querySelectorAll('.panel-header').forEach(header => {
                        header.style.background = this.customization.panelGradient;
                    });
                }
                if (this.customization.logoUrl) {
                    this.updateLogo(this.customization.logoUrl);
                }

                // Load panel positions
                const positions = JSON.parse(localStorage.getItem('panel_positions') || '{}');
                Object.keys(positions).forEach(panelId => {
                    const panel = document.getElementById(panelId);
                    if (panel && positions[panelId]) {
                        const pos = positions[panelId];
                        if (pos.left !== undefined) panel.style.left = pos.left;
                        if (pos.top !== undefined) panel.style.top = pos.top;
                        if (pos.right !== undefined) panel.style.right = pos.right;
                        if (pos.bottom !== undefined) panel.style.bottom = pos.bottom;
                        if (pos.width !== undefined) {
                            panel.style.width = pos.width;
                            panel.style.maxWidth = 'none';
                        }
                        if (pos.height !== undefined) {
                            panel.style.height = pos.height;
                            panel.style.maxHeight = 'none';
                        }
                        if (pos.minimized) {
                            panel.classList.add('minimized');
                            const btns = panel.querySelectorAll('.panel-controls .panel-btn');
                            if (btns[0]) {
                                btns[0].textContent = '+';
                                btns[0].title = 'Maximize';
                            }
                        }
                    }
                });

                // Set initial button states for minimized panels
                document.querySelectorAll('.floating-panel.minimized').forEach(panel => {
                    const btns = panel.querySelectorAll('.panel-controls .panel-btn');
                    if (btns[0]) {
                        btns[0].textContent = '+';
                        btns[0].title = 'Maximize';
                    }
                });
            },

            resetCustomization() {
                if (confirm('Reset all customizations to default?')) {
                    this.customization = {
                        bgTheme: 'default',
                        panelColor: 'default',
                        logoUrl: null
                    };
                    localStorage.removeItem('panel_customization');
                    localStorage.removeItem('panel_positions');
                    location.reload();
                }
            },

            saveCustomization() {
                localStorage.setItem('panel_customization', JSON.stringify(this.customization));
            },

            loadCustomization() {
                const saved = localStorage.getItem('panel_customization');
                if (saved) {
                    this.customization = JSON.parse(saved);
                }
            },

            savePanelPositions() {
                const positions = {};
                document.querySelectorAll('.floating-panel').forEach(panel => {
                    positions[panel.id] = {
                        left: panel.style.left,
                        top: panel.style.top,
                        right: panel.style.right,
                        bottom: panel.style.bottom,
                        width: panel.style.width,
                        height: panel.style.height,
                        minimized: panel.classList.contains('minimized')
                    };
                });
                localStorage.setItem('panel_positions', JSON.stringify(positions));
            },

            // Sidebar toggle
            toggleSidebar() {
                this.sidebarOpen = !this.sidebarOpen;
                const sidebar = document.getElementById('panelSidebar');
                sidebar.classList.toggle('open', this.sidebarOpen);
            },

            // Render panel toggle list
            renderPanelToggles() {
                const container = document.getElementById('panelToggleList');
                container.innerHTML = this.panels.map(panel => `
                    <div class="panel-toggle-item">
                        <input type="checkbox" id="toggle_${panel.id}"
                               ${panel.visible ? 'checked' : ''}
                               onchange="panelManager.togglePanel('${panel.id}')">
                        <label for="toggle_${panel.id}">${panel.name}</label>
                    </div>
                `).join('');
            },

            // Toggle panel visibility
            togglePanel(panelId) {
                const panelConfig = this.panels.find(p => p.id === panelId);
                if (panelConfig) {
                    panelConfig.visible = !panelConfig.visible;
                    this.updatePanelVisibility();
                    this.savePanelVisibility();
                }
            },

            // Update panel visibility
            updatePanelVisibility() {
                this.panels.forEach(panelConfig => {
                    const panel = document.getElementById(panelConfig.id);
                    if (panel) {
                        panel.style.display = panelConfig.visible ? 'flex' : 'none';
                    }
                });
            },

            // Save panel visibility
            savePanelVisibility() {
                const visibility = {};
                this.panels.forEach(p => {
                    visibility[p.id] = p.visible;
                });
                localStorage.setItem('panel_visibility', JSON.stringify(visibility));
            },

            // Load panel visibility
            loadPanelVisibility() {
                const saved = localStorage.getItem('panel_visibility');
                if (saved) {
                    const visibility = JSON.parse(saved);
                    this.panels.forEach(p => {
                        if (visibility.hasOwnProperty(p.id)) {
                            p.visible = visibility[p.id];
                        }
                    });
                }
            },

            // Initialize panel resizing
            initPanelResizing() {
                // Add resize handles to all panels
                document.querySelectorAll('.floating-panel').forEach(panel => {
                    const directions = ['n', 's', 'e', 'w', 'ne', 'nw', 'se', 'sw'];
                    directions.forEach(dir => {
                        const handle = document.createElement('div');
                        handle.className = `panel-resize-handle ${dir}`;
                        handle.dataset.direction = dir;
                        handle.addEventListener('mousedown', (e) => this.startResize(e, panel, dir));
                        panel.appendChild(handle);
                    });
                });

                document.addEventListener('mousemove', (e) => this.resize(e));
                document.addEventListener('mouseup', () => this.stopResize());
            },

            startResize(e, panel, direction) {
                e.stopPropagation();
                e.preventDefault();

                this.resizingPanel = panel;
                this.resizeDirection = direction;
                this.bringToFront(panel);

                this.resizeStart = {
                    x: e.clientX,
                    y: e.clientY,
                    width: panel.offsetWidth,
                    height: panel.offsetHeight,
                    left: panel.offsetLeft,
                    top: panel.offsetTop
                };

                panel.classList.add('resizing');
            },

            resize(e) {
                if (!this.resizingPanel || !this.resizeDirection) return;

                const deltaX = e.clientX - this.resizeStart.x;
                const deltaY = e.clientY - this.resizeStart.y;

                let newWidth = this.resizeStart.width;
                let newHeight = this.resizeStart.height;
                let newLeft = this.resizeStart.left;
                let newTop = this.resizeStart.top;

                const dir = this.resizeDirection;

                // Calculate new dimensions based on direction
                if (dir.includes('e')) {
                    newWidth = Math.max(300, this.resizeStart.width + deltaX);
                }
                if (dir.includes('w')) {
                    newWidth = Math.max(300, this.resizeStart.width - deltaX);
                    if (newWidth > 300) {
                        newLeft = this.resizeStart.left + deltaX;
                    }
                }
                if (dir.includes('s')) {
                    newHeight = Math.max(200, this.resizeStart.height + deltaY);
                }
                if (dir.includes('n')) {
                    newHeight = Math.max(200, this.resizeStart.height - deltaY);
                    if (newHeight > 200) {
                        newTop = this.resizeStart.top + deltaY;
                    }
                }

                // Apply new dimensions
                this.resizingPanel.style.width = newWidth + 'px';
                this.resizingPanel.style.height = newHeight + 'px';
                this.resizingPanel.style.left = newLeft + 'px';
                this.resizingPanel.style.top = newTop + 'px';
                this.resizingPanel.style.maxWidth = 'none';
                this.resizingPanel.style.maxHeight = 'none';
            },

            stopResize() {
                if (this.resizingPanel) {
                    this.resizingPanel.classList.remove('resizing');
                    this.savePanelPositions();
                    this.resizingPanel = null;
                    this.resizeDirection = null;
                }
            }
        };

        const controlPanel = {
            // State (synced with main viewer via localStorage)
            gridLayout: '2x2',
            gridStreams: [],
            savedStreamers: [],
            activeAudioIndex: null,

            init() {
                this.loadState();
                this.renderLayouts();
                this.renderSavedStreamers();
                this.renderAudioControl();
                this.setupEventListeners();

                // Listen for storage changes from viewer
                window.addEventListener('storage', (e) => {
                    if (e.key && e.key.startsWith('multistream_')) {
                        this.loadState();
                        this.renderLayouts();
                        this.renderSavedStreamers();
                        this.renderAudioControl();
                    }
                });

                // Auto-focus name input
                document.getElementById('streamName').focus();
            },

            loadState() {
                this.gridLayout = localStorage.getItem('multistream_layout') || '2x2';
                this.gridStreams = JSON.parse(localStorage.getItem('multistream_grid') || '[]');
                this.activeAudioIndex = parseInt(localStorage.getItem('multistream_audio') || '-1');

                // Load streamers (new format) or migrate from old saved streams
                const savedStreamers = localStorage.getItem('multistream_streamers');
                if (savedStreamers) {
                    this.savedStreamers = JSON.parse(savedStreamers);
                } else {
                    // Migration: convert old saved streams to streamers
                    const oldStreams = JSON.parse(localStorage.getItem('multistream_saved') || '[]');
                    this.savedStreamers = oldStreams.map(stream => this.convertStreamToStreamer(stream));
                    if (this.savedStreamers.length > 0) {
                        localStorage.setItem('multistream_streamers', JSON.stringify(this.savedStreamers));
                    }
                }
            },

            convertStreamToStreamer(stream) {
                const platformInfo = this.extractPlatformInfo(stream.url);
                return {
                    id: platformInfo.id,
                    platform: platformInfo.platform,
                    handle: platformInfo.handle,
                    displayName: stream.name,
                    profileUrl: stream.url,
                    createdAt: Date.now()
                };
            },

            extractPlatformInfo(url) {
                // Twitch
                if (url.includes('twitch.tv')) {
                    const handle = url.split('twitch.tv/')[1]?.split('/')[0] || 'unknown';
                    return { platform: 'twitch', handle: handle, id: `twitch:${handle}` };
                }
                // YouTube @handle
                if (url.includes('youtube.com/@') || url.includes('youtu.be/@')) {
                    const handleMatch = url.match(/\/@([^\/\?]+)/);
                    if (handleMatch) {
                        const handle = handleMatch[1];
                        return { platform: 'youtube', handle: '@' + handle, id: `youtube:@${handle}` };
                    }
                }
                // YouTube channel ID
                if (url.includes('youtube.com/channel/')) {
                    const channelMatch = url.match(/\/channel\/([^\/\?]+)/);
                    if (channelMatch) {
                        const channelId = channelMatch[1];
                        return { platform: 'youtube', handle: channelId, id: `youtube:${channelId}` };
                    }
                }
                // X (Twitter)
                if (url.includes('x.com') || url.includes('twitter.com')) {
                    const usernameMatch = url.match(/(?:x\.com|twitter\.com)\/([^\/]+)/);
                    if (usernameMatch) {
                        const handle = usernameMatch[1];
                        return { platform: 'x', handle: '@' + handle, id: `x:@${handle}` };
                    }
                }
                // TikTok
                if (url.includes('tiktok.com')) {
                    const usernameMatch = url.match(/@([^\/\?]+)/);
                    if (usernameMatch) {
                        const handle = usernameMatch[1];
                        return { platform: 'tiktok', handle: '@' + handle, id: `tiktok:@${handle}` };
                    }
                }
                // Default
                return { platform: 'unknown', handle: 'unknown', id: `unknown:${Date.now()}` };
            },

            async resolveYouTubeStreamer(videoUrl) {
                try {
                    const endpoint = `https://www.youtube.com/oembed?format=json&url=${encodeURIComponent(videoUrl)}`;
                    const response = await fetch(endpoint);
                    if (!response.ok) throw new Error('YouTube oEmbed failed');
                    const data = await response.json();

                    let handle = 'unknown';
                    if (data.author_url) {
                        const handleMatch = data.author_url.match(/\/@([^\/\?]+)/);
                        const channelMatch = data.author_url.match(/\/channel\/([^\/\?]+)/);
                        if (handleMatch) handle = '@' + handleMatch[1];
                        else if (channelMatch) handle = channelMatch[1];
                    }

                    return {
                        id: `youtube:${handle}`,
                        platform: 'youtube',
                        handle: handle,
                        displayName: data.author_name || 'Unknown Channel',
                        profileUrl: data.author_url || videoUrl,
                        createdAt: Date.now()
                    };
                } catch (error) {
                    console.error('YouTube oEmbed failed:', error);
                    return null;
                }
            },

            async resolveTikTokStreamer(videoUrl) {
                try {
                    const endpoint = `https://www.tiktok.com/oembed?url=${encodeURIComponent(videoUrl)}`;
                    const response = await fetch(endpoint);
                    if (!response.ok) throw new Error('TikTok oEmbed failed');
                    const data = await response.json();

                    let handle = 'unknown';
                    if (data.author_url) {
                        const handleMatch = data.author_url.match(/@([^\/\?]+)/);
                        if (handleMatch) handle = '@' + handleMatch[1];
                    }

                    return {
                        id: `tiktok:${handle}`,
                        platform: 'tiktok',
                        handle: handle,
                        displayName: data.author_name || data.author_unique_id || 'Unknown TikToker',
                        profileUrl: data.author_url || videoUrl,
                        createdAt: Date.now()
                    };
                } catch (error) {
                    console.error('TikTok oEmbed failed:', error);
                    return null;
                }
            },

            async saveStreamerFromUrl(url, customName = null) {
                let streamer = null;

                // Twitch
                if (url.includes('twitch.tv')) {
                    const handle = url.split('twitch.tv/')[1]?.split('/')[0];
                    streamer = {
                        id: `twitch:${handle}`,
                        platform: 'twitch',
                        handle: handle,
                        displayName: customName || handle,
                        profileUrl: `https://twitch.tv/${handle}`,
                        createdAt: Date.now()
                    };
                }
                // YouTube video URLs - use oEmbed
                else if (url.includes('youtube.com/watch') || url.includes('youtube.com/live') || url.includes('youtu.be/')) {
                    streamer = await this.resolveYouTubeStreamer(url);
                    if (streamer && customName) streamer.displayName = customName;
                }
                // YouTube channel/handle URLs
                else if (url.includes('youtube.com/@') || url.includes('youtube.com/channel/')) {
                    const platformInfo = this.extractPlatformInfo(url);
                    streamer = {
                        id: platformInfo.id,
                        platform: 'youtube',
                        handle: platformInfo.handle,
                        displayName: customName || platformInfo.handle,
                        profileUrl: url,
                        createdAt: Date.now()
                    };
                }
                // TikTok - use oEmbed
                else if (url.includes('tiktok.com')) {
                    streamer = await this.resolveTikTokStreamer(url);
                    if (streamer && customName) streamer.displayName = customName;
                    // Fallback if oEmbed fails
                    if (!streamer) {
                        const platformInfo = this.extractPlatformInfo(url);
                        streamer = {
                            id: platformInfo.id,
                            platform: 'tiktok',
                            handle: platformInfo.handle,
                            displayName: customName || platformInfo.handle,
                            profileUrl: url,
                            createdAt: Date.now()
                        };
                    }
                }
                // Other platforms
                else {
                    const platformInfo = this.extractPlatformInfo(url);
                    streamer = {
                        id: platformInfo.id,
                        platform: platformInfo.platform,
                        handle: platformInfo.handle,
                        displayName: customName || 'Unknown',
                        profileUrl: url,
                        createdAt: Date.now()
                    };
                }

                if (streamer) {
                    // Check if already exists
                    const existingIndex = this.savedStreamers.findIndex(s => s.id === streamer.id);
                    if (existingIndex >= 0) {
                        this.savedStreamers[existingIndex] = streamer;
                    } else {
                        this.savedStreamers.push(streamer);
                    }
                    this.saveState();
                    this.renderSavedStreamers();
                    return streamer;
                }
                return null;
            },

            saveState() {
                localStorage.setItem('multistream_layout', this.gridLayout);
                localStorage.setItem('multistream_grid', JSON.stringify(this.gridStreams));
                localStorage.setItem('multistream_streamers', JSON.stringify(this.savedStreamers));

                // Trigger storage event for viewer
                window.dispatchEvent(new Event('storage'));
            },

            renderLayouts() {
                const layouts = ['1x1', '1x2', '2x1', '2x2', '2x3', '3x2', '3x3', '4x2', '2x4', '4x4'];
                const container = document.getElementById('layoutSelector');

                container.innerHTML = layouts.map(layout => {
                    const [rows, cols] = layout.split('x');
                    const isActive = layout === this.gridLayout;
                    return `
                        <button
                            class="grid-btn ${isActive ? 'active' : ''}"
                            onclick="controlPanel.setLayout('${layout}')">
                            ${rows}√ó${cols}
                        </button>
                    `;
                }).join('');
            },

            setLayout(layout) {
                this.gridLayout = layout;
                const [rows, cols] = layout.split('x').map(Number);
                const newTotal = rows * cols;

                // Resize grid array
                const newGrid = Array(newTotal).fill(null);
                for (let i = 0; i < Math.min(this.gridStreams.length, newTotal); i++) {
                    newGrid[i] = this.gridStreams[i];
                }
                this.gridStreams = newGrid;

                this.saveState();
                this.renderLayouts();
            },

            async addStream() {
                const name = document.getElementById('streamName').value.trim();
                const url = document.getElementById('streamUrl').value.trim();
                const shouldSaveStreamer = document.getElementById('saveStreamer').checked;

                if (!name || !url) {
                    alert('Please enter both stream name and URL');
                    return;
                }

                const stream = { name, url, size: '1x1' };

                // Save streamer if checked
                if (shouldSaveStreamer) {
                    await this.saveStreamerFromUrl(url, name);
                }

                // Find first empty slot
                const emptyIndex = this.gridStreams.findIndex(s => s === null);
                if (emptyIndex >= 0) {
                    this.gridStreams[emptyIndex] = stream;
                    this.saveState();

                    // Clear form
                    document.getElementById('streamName').value = '';
                    document.getElementById('streamUrl').value = '';
                    document.getElementById('streamName').focus();

                    this.renderSavedStreamers();
                } else {
                    alert('Grid is full! Clear a slot or change to a larger layout.');
                }
            },

            renderSavedStreamers() {
                const container = document.getElementById('savedStreamersList');

                if (this.savedStreamers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üíæ</div>
                            <div>No saved streamers yet</div>
                            <div style="font-size: 12px; margin-top: 8px;">Save streamers for quick access later</div>
                        </div>
                    `;
                    return;
                }

                const platformEmoji = {
                    'twitch': 'üíú',
                    'youtube': '‚ñ∂Ô∏è',
                    'facebook': 'üëç',
                    'rumble': 'üé•',
                    'x': 'ùïè',
                    'tiktok': 'üéµ',
                    'unknown': 'üì∫'
                };

                container.innerHTML = this.savedStreamers.map((streamer, index) => `
                    <div class="streamer-item">
                        <div class="streamer-info">
                            <div class="streamer-name" onclick="controlPanel.openInViewer(${index})" title="Click to open in main viewer">
                                ${platformEmoji[streamer.platform] || 'üì∫'} ${this.escapeHtml(streamer.displayName)}
                            </div>
                            <div class="streamer-meta">
                                ${this.escapeHtml(streamer.platform)} ¬∑ ${this.escapeHtml(streamer.handle)}
                            </div>
                        </div>
                        <div class="streamer-actions">
                            <button class="btn btn-secondary btn-small" onclick="controlPanel.useStreamer(${index})" title="Add to grid">
                                ‚ñ∂Ô∏è Use
                            </button>
                            <button class="btn btn-danger btn-small" onclick="controlPanel.deleteStreamer(${index})">
                                ‚úï
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            renderAudioControl() {
                const container = document.getElementById('audioControlList');
                const activeStreams = this.gridStreams.filter(s => s !== null);

                if (activeStreams.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üîá</div>
                            <div>No active streams</div>
                            <div style="font-size: 12px; margin-top: 8px;">Add streams to control audio</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.gridStreams.map((stream, index) => {
                    if (!stream) return '';
                    const isActive = index === this.activeAudioIndex;
                    return `
                        <div class="stream-item" style="cursor: pointer; ${isActive ? 'border: 2px solid #10B981;' : ''}"
                             onclick="controlPanel.setAudio(${index})">
                            <div class="stream-info">
                                <div class="stream-name">
                                    ${isActive ? 'üîä' : 'üîá'} ${this.escapeHtml(stream.name)}
                                </div>
                            </div>
                            <div class="stream-actions">
                                ${isActive ? '<span style="color: #10B981; font-weight: 600;">ACTIVE</span>' : '<span style="color: #64748B;">Click to activate</span>'}
                            </div>
                        </div>
                    `;
                }).filter(Boolean).join('');
            },

            setAudio(index) {
                // Toggle audio
                if (this.activeAudioIndex === index) {
                    this.activeAudioIndex = null;
                } else {
                    this.activeAudioIndex = index;
                }

                localStorage.setItem('multistream_audio', this.activeAudioIndex);
                this.renderAudioControl();

                // Trigger storage event for viewer
                window.dispatchEvent(new Event('storage'));
            },

            useStreamer(index) {
                const streamer = this.savedStreamers[index];
                const stream = {
                    name: streamer.displayName,
                    url: streamer.profileUrl,
                    size: '1x1'
                };

                const emptyIndex = this.gridStreams.findIndex(s => s === null);
                if (emptyIndex >= 0) {
                    this.gridStreams[emptyIndex] = stream;
                    this.saveState();
                } else {
                    alert('Grid is full! Clear a slot or change to a larger layout.');
                }
            },

            getMainPageUrl(streamer) {
                // Get the main page/channel URL to check if they're live
                switch(streamer.platform) {
                    case 'youtube':
                        // For YouTube, use the channel URL or handle
                        if (streamer.handle.startsWith('@')) {
                            return `https://www.youtube.com/${streamer.handle}`;
                        } else {
                            return streamer.profileUrl;
                        }
                    case 'twitch':
                        // For Twitch, use twitch.tv/username
                        const twitchHandle = streamer.handle.replace('@', '');
                        return `https://www.twitch.tv/${twitchHandle}`;
                    case 'x':
                        // For X, use x.com/username
                        const xHandle = streamer.handle.replace('@', '');
                        return `https://x.com/${xHandle}`;
                    case 'tiktok':
                        // For TikTok, use tiktok.com/@username/live to check live status
                        return `https://www.tiktok.com/${streamer.handle}/live`;
                    case 'facebook':
                        // For Facebook, use the profile URL
                        return streamer.profileUrl;
                    case 'rumble':
                        // For Rumble, use the profile URL
                        return streamer.profileUrl;
                    default:
                        return streamer.profileUrl;
                }
            },

            openInViewer(index) {
                const streamer = this.savedStreamers[index];
                const mainPageUrl = this.getMainPageUrl(streamer);

                const stream = {
                    name: streamer.displayName,
                    url: mainPageUrl,
                    size: '1x1'
                };

                // Find first empty slot in the grid
                const emptyIndex = this.gridStreams.findIndex(s => s === null);
                if (emptyIndex >= 0) {
                    this.gridStreams[emptyIndex] = stream;
                    this.saveState();

                    // Show success message
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: rgba(16, 185, 129, 0.95);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-size: 14px;
                        font-weight: 600;
                    `;
                    notification.textContent = `‚úì Opened ${streamer.displayName} in main viewer`;
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.style.transition = 'opacity 0.3s';
                        notification.style.opacity = '0';
                        setTimeout(() => notification.remove(), 300);
                    }, 2000);
                } else {
                    alert('Grid is full! Clear a slot or change to a larger layout first.');
                }
            },

            deleteStreamer(index) {
                if (confirm(`Delete "${this.savedStreamers[index].displayName}"?`)) {
                    this.savedStreamers.splice(index, 1);
                    this.saveState();
                    this.renderSavedStreamers();
                }
            },

            clearAllStreams() {
                if (confirm('Remove all streams from the viewer grid?')) {
                    this.gridStreams = this.gridStreams.map(() => null);
                    this.saveState();
                }
            },

            refreshViewer() {
                this.saveState();
                alert('Viewer refreshed! All changes synchronized.');
            },

            setupEventListeners() {
                // Enter key to add stream
                document.getElementById('streamName').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('streamUrl').focus();
                    }
                });

                document.getElementById('streamUrl').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.addStream();
                    }
                });
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Chat Manager for Unified Chat
        const chatManager = {
            twitchClient: null,
            twitchToken: null,
            twitchChannels: [],
            youtubeToken: null,
            youtubeTokenExpiry: null,
            youtubeLiveChatId: null,
            youtubeNextPageToken: null,
            messages: [],
            maxMessages: 100,

            init() {
                this.loadTokens();
                this.updateLoginButtons();

                // Auto-connect if we have tokens
                if (this.twitchToken) {
                    this.connectTwitch();
                }
            },

            loadTokens() {
                this.twitchToken = localStorage.getItem('twitch_token');
                this.twitchChannels = JSON.parse(localStorage.getItem('twitch_channels') || '[]');
                this.youtubeToken = localStorage.getItem('youtube_token');
                const expiry = localStorage.getItem('youtube_token_expiry');
                if (expiry) {
                    this.youtubeTokenExpiry = parseInt(expiry);
                    // Check if token is expired
                    if (Date.now() > this.youtubeTokenExpiry) {
                        this.youtubeToken = null;
                        localStorage.removeItem('youtube_token');
                        localStorage.removeItem('youtube_token_expiry');
                    }
                }
            },

            saveTokens() {
                if (this.twitchToken) {
                    localStorage.setItem('twitch_token', this.twitchToken);
                }
                if (this.twitchChannels.length > 0) {
                    localStorage.setItem('twitch_channels', JSON.stringify(this.twitchChannels));
                }
                if (this.youtubeToken) {
                    localStorage.setItem('youtube_token', this.youtubeToken);
                }
            },

            updateLoginButtons() {
                const twitchBtn = document.getElementById('twitchLoginBtn');
                const twitchText = document.getElementById('twitchLoginText');
                const youtubeBtn = document.getElementById('youtubeLoginBtn');
                const youtubeText = document.getElementById('youtubeLoginText');

                if (this.twitchToken) {
                    twitchBtn.classList.add('connected');
                    twitchText.textContent = 'Connected';
                } else {
                    twitchBtn.classList.remove('connected');
                    twitchText.textContent = 'Login Twitch';
                }

                if (this.youtubeToken) {
                    youtubeBtn.classList.add('connected');
                    youtubeText.textContent = 'Connected';
                } else {
                    youtubeBtn.classList.remove('connected');
                    youtubeText.textContent = 'Login YouTube';
                }
            },

            loginTwitch() {
                if (this.twitchToken) {
                    // Already connected - offer to disconnect
                    if (confirm('Disconnect from Twitch?')) {
                        this.disconnectTwitch();
                    }
                    return;
                }

                // Simple token input for now (user gets it from https://twitchapps.com/tmi/)
                const token = prompt(
                    'Get your Twitch OAuth token from:\nhttps://twitchapps.com/tmi/\n\nPaste token here (starts with oauth:):'
                );

                if (token && token.startsWith('oauth:')) {
                    this.twitchToken = token;

                    // Ask for channels to join
                    const channels = prompt('Enter Twitch channel names to join (comma-separated):\nExample: hasanabi,pokimane');
                    if (channels) {
                        this.twitchChannels = channels.split(',').map(c => c.trim().toLowerCase());
                    }

                    this.saveTokens();
                    this.connectTwitch();
                }
            },

            async connectTwitch() {
                if (!this.twitchToken || !window.tmi) {
                    console.error('TMI.js not loaded or no token');
                    return;
                }

                try {
                    this.twitchClient = new tmi.Client({
                        options: { debug: false },
                        identity: {
                            username: 'justinfan' + Math.floor(Math.random() * 100000),
                            password: this.twitchToken
                        },
                        channels: this.twitchChannels
                    });

                    this.twitchClient.on('message', (channel, tags, message, self) => {
                        this.addMessage({
                            platform: 'twitch',
                            username: tags['display-name'] || tags.username,
                            text: message,
                            timestamp: new Date()
                        });
                    });

                    this.twitchClient.on('connected', () => {
                        this.showStatus('Connected to Twitch chat!', 'connected');
                        this.updateLoginButtons();
                    });

                    await this.twitchClient.connect();
                } catch (error) {
                    console.error('Twitch connection error:', error);
                    this.showStatus('Failed to connect to Twitch', 'error');
                }
            },

            disconnectTwitch() {
                if (this.twitchClient) {
                    this.twitchClient.disconnect();
                    this.twitchClient = null;
                }
                this.twitchToken = null;
                this.twitchChannels = [];
                localStorage.removeItem('twitch_token');
                localStorage.removeItem('twitch_channels');
                this.updateLoginButtons();
                this.showStatus('Disconnected from Twitch');
            },

            async loginYouTube() {
                if (this.youtubeToken) {
                    if (confirm('Disconnect from YouTube?')) {
                        this.disconnectYouTube();
                    }
                    return;
                }

                // Check if we have OAuth client ID
                let clientId = localStorage.getItem('youtube_chat_client_id');

                if (!clientId) {
                    clientId = prompt(
                        'To connect YouTube Live Chat, you need a Google OAuth Client ID.\n\n' +
                        '1. Go to: https://console.cloud.google.com/apis/credentials\n' +
                        '2. Enable YouTube Data API v3\n' +
                        '3. Create OAuth 2.0 Client ID (Web application)\n' +
                        '4. Add your domain to authorized origins\n\n' +
                        'Paste your Client ID here:'
                    );

                    if (!clientId) return;
                    localStorage.setItem('youtube_chat_client_id', clientId.trim());
                    clientId = clientId.trim();
                }

                try {
                    await this.connectYouTube(clientId);
                } catch (error) {
                    console.error('YouTube auth error:', error);
                    alert('YouTube authentication failed: ' + error.message);
                }
            },

            async connectYouTube(clientId) {
                // Check if running in Electron (desktop app)
                const isElectron = window.electron && window.electron.isElectron;
                const scope = 'https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/youtube.force-ssl';
                const state = 'youtube_chat_' + Math.random().toString(36).substr(2);
                sessionStorage.setItem('youtube_oauth_state', state);

                let redirectUri;
                if (isElectron) {
                    // Electron: Use loopback redirect (Google requires this for desktop apps)
                    const serverInfo = await window.electron.oauth.startServer();
                    redirectUri = serverInfo.redirectUri;
                    console.log('Electron OAuth: Using redirect URI:', redirectUri);
                } else {
                    // Web: Use current page origin
                    redirectUri = window.location.origin + window.location.pathname;
                }

                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                    `client_id=${encodeURIComponent(clientId)}` +
                    `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                    `&response_type=token` +
                    `&scope=${encodeURIComponent(scope)}` +
                    `&state=${encodeURIComponent(state)}`;

                // Open OAuth popup
                const width = 500;
                const height = 600;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;

                const popup = window.open(
                    authUrl,
                    'YouTube Sign In',
                    `width=${width},height=${height},left=${left},top=${top}`
                );

                const self = this;

                // Listen for OAuth callback
                return new Promise((resolve, reject) => {
                    let resolved = false;

                    const handleToken = (popupUrl) => {
                        if (resolved) return;
                        resolved = true;

                        // Parse token from URL
                        const params = new URLSearchParams(popupUrl.split('#')[1]);

                        // Validate state
                        const returnedState = params.get('state');
                        const expectedState = sessionStorage.getItem('youtube_oauth_state');
                        sessionStorage.removeItem('youtube_oauth_state');

                        if (returnedState !== expectedState) {
                            reject(new Error('Invalid OAuth state'));
                            return;
                        }

                        self.youtubeToken = params.get('access_token');
                        const expiresIn = parseInt(params.get('expires_in')) || 3600;
                        self.youtubeTokenExpiry = Date.now() + (expiresIn * 1000);

                        localStorage.setItem('youtube_token', self.youtubeToken);
                        localStorage.setItem('youtube_token_expiry', self.youtubeTokenExpiry.toString());

                        self.updateLoginButtons();
                        self.showStatus('Connected to YouTube!', 'connected');

                        // Ask for video URL to monitor
                        const videoUrl = prompt('Enter YouTube Live video URL to monitor chat:');
                        if (videoUrl) {
                            self.startYouTubeChatMonitoring(videoUrl);
                        }

                        resolve(true);
                    };

                    // For Electron, also listen for IPC callback
                    if (isElectron) {
                        window.electron.oauth.onCallback((data) => {
                            if (resolved) return;
                            try {
                                if (popup && !popup.closed) {
                                    const popupUrl = popup.location.href;
                                    if (popupUrl.includes('access_token=')) {
                                        popup.close();
                                        window.electron.oauth.stopServer();
                                        handleToken(popupUrl);
                                    }
                                }
                            } catch (e) {
                                // Cross-origin error
                            }
                        });
                    }

                    const checkPopup = setInterval(() => {
                        if (resolved) {
                            clearInterval(checkPopup);
                            return;
                        }

                        try {
                            if (!popup || popup.closed) {
                                clearInterval(checkPopup);
                                if (!resolved) {
                                    if (isElectron) window.electron.oauth.stopServer();
                                    reject(new Error('Sign-in popup was closed'));
                                }
                                return;
                            }

                            // Check if we got redirected back with token
                            const popupUrl = popup.location.href;
                            if (popupUrl.includes('access_token=')) {
                                clearInterval(checkPopup);
                                popup.close();
                                if (isElectron) window.electron.oauth.stopServer();
                                handleToken(popupUrl);
                            }
                        } catch (error) {
                            // Cross-origin error - popup hasn't redirected back yet
                        }
                    }, 500);

                    // Timeout after 5 minutes
                    setTimeout(() => {
                        if (!resolved) {
                            clearInterval(checkPopup);
                            if (popup && !popup.closed) popup.close();
                            if (isElectron) window.electron.oauth.stopServer();
                            reject(new Error('Sign-in timeout'));
                        }
                    }, 300000);
                });
            },

            async startYouTubeChatMonitoring(videoUrl) {
                try {
                    // Extract video ID from URL
                    const videoId = this.extractYouTubeVideoId(videoUrl);
                    if (!videoId) {
                        throw new Error('Invalid YouTube URL');
                    }

                    // Get live chat ID
                    const response = await fetch(
                        `https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${videoId}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${this.youtubeToken}`
                            }
                        }
                    );

                    if (!response.ok) throw new Error('Failed to get video details');

                    const data = await response.json();
                    const liveChatId = data.items[0]?.liveStreamingDetails?.activeLiveChatId;

                    if (!liveChatId) {
                        throw new Error('No active live chat found for this video');
                    }

                    this.youtubeLiveChatId = liveChatId;
                    this.pollYouTubeChat();
                    this.showStatus('Monitoring YouTube chat...', 'connected');
                } catch (error) {
                    console.error('YouTube chat error:', error);
                    alert('Failed to connect to YouTube chat: ' + error.message);
                }
            },

            async pollYouTubeChat() {
                if (!this.youtubeToken || !this.youtubeLiveChatId) return;

                try {
                    const url = `https://www.googleapis.com/youtube/v3/liveChat/messages?` +
                        `liveChatId=${this.youtubeLiveChatId}&part=snippet,authorDetails` +
                        (this.youtubeNextPageToken ? `&pageToken=${this.youtubeNextPageToken}` : '');

                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${this.youtubeToken}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            this.disconnectYouTube();
                            this.showStatus('YouTube token expired', 'error');
                            return;
                        }
                        throw new Error('Failed to fetch messages');
                    }

                    const data = await response.json();
                    this.youtubeNextPageToken = data.nextPageToken;

                    // Process new messages
                    if (data.items) {
                        data.items.forEach(item => {
                            this.addMessage({
                                platform: 'youtube',
                                username: item.authorDetails.displayName,
                                text: item.snippet.displayMessage,
                                timestamp: new Date(item.snippet.publishedAt)
                            });
                        });
                    }

                    // Schedule next poll
                    const pollingInterval = data.pollingIntervalMillis || 5000;
                    setTimeout(() => this.pollYouTubeChat(), pollingInterval);

                } catch (error) {
                    console.error('YouTube chat polling error:', error);
                    // Retry after delay
                    setTimeout(() => this.pollYouTubeChat(), 10000);
                }
            },

            extractYouTubeVideoId(url) {
                const patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
                    /youtube\.com\/live\/([a-zA-Z0-9_-]{11})/
                ];

                for (const pattern of patterns) {
                    const match = url.match(pattern);
                    if (match) return match[1];
                }

                return null;
            },

            disconnectYouTube() {
                this.youtubeToken = null;
                this.youtubeLiveChatId = null;
                this.youtubeNextPageToken = null;
                localStorage.removeItem('youtube_token');
                localStorage.removeItem('youtube_token_expiry');
                this.updateLoginButtons();
                this.showStatus('Disconnected from YouTube');
            },

            addMessage(msg) {
                this.messages.push(msg);

                // Keep only last N messages
                if (this.messages.length > this.maxMessages) {
                    this.messages.shift();
                }

                this.renderMessages();
            },

            renderMessages() {
                const feed = document.getElementById('chatFeed');

                if (this.messages.length === 0) {
                    feed.innerHTML = `
                        <div class="chat-empty">
                            <div class="chat-empty-icon">üí¨</div>
                            <div>Login to platforms to see unified chat</div>
                            <div style="font-size: 12px; margin-top: 8px;">All platform chats will appear here in real-time</div>
                        </div>
                    `;
                    return;
                }

                feed.innerHTML = this.messages.map(msg => {
                    const time = msg.timestamp.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    return `
                        <div class="chat-message ${msg.platform}">
                            <div class="chat-meta">
                                <span class="chat-platform ${msg.platform}">${msg.platform}</span>
                                <span class="chat-username">${this.escapeHtml(msg.username)}</span>
                                <span class="chat-timestamp">${time}</span>
                            </div>
                            <div class="chat-text">${this.escapeHtml(msg.text)}</div>
                        </div>
                    `;
                }).join('');

                // Auto-scroll to bottom
                feed.scrollTop = feed.scrollHeight;
            },

            showStatus(message, type = '') {
                const status = document.getElementById('chatStatus');
                if (!message) {
                    status.innerHTML = '';
                    return;
                }

                status.innerHTML = `<div class="chat-status ${type}">${message}</div>`;

                if (type !== 'connected') {
                    setTimeout(() => {
                        status.innerHTML = '';
                    }, 3000);
                }
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Overlay Manager for Stream Alerts
        const overlayManager = {
            alertConfig: {
                type: 'follow',
                text: '{username} just followed!',
                duration: 5,
                color: '#ffffff',
                animation: 'fade',
                soundUrl: null
            },

            init() {
                this.loadAlertConfig();
                this.generateOverlayUrl();
            },

            loadAlertConfig() {
                const saved = localStorage.getItem('alert_config');
                if (saved) {
                    this.alertConfig = JSON.parse(saved);
                    this.applyConfigToForm();
                }
            },

            applyConfigToForm() {
                document.getElementById('alertType').value = this.alertConfig.type;
                document.getElementById('alertText').value = this.alertConfig.text;
                document.getElementById('alertDuration').value = this.alertConfig.duration;
                document.getElementById('alertColor').value = this.alertConfig.color;
                document.getElementById('alertAnimation').value = this.alertConfig.animation;
            },

            saveAlertConfig() {
                // Get sound file if uploaded
                const soundFile = document.getElementById('alertSound').files[0];
                if (soundFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.alertConfig.soundUrl = e.target.result;
                        this.saveConfig();
                    };
                    reader.readAsDataURL(soundFile);
                } else {
                    this.saveConfig();
                }
            },

            saveConfig() {
                this.alertConfig.type = document.getElementById('alertType').value;
                this.alertConfig.text = document.getElementById('alertText').value;
                this.alertConfig.duration = parseInt(document.getElementById('alertDuration').value);
                this.alertConfig.color = document.getElementById('alertColor').value;
                this.alertConfig.animation = document.getElementById('alertAnimation').value;

                localStorage.setItem('alert_config', JSON.stringify(this.alertConfig));
                this.generateOverlayUrl();

                alert('Alert configuration saved! Copy the overlay URL for OBS.');
            },

            generateOverlayUrl() {
                // Generate a unique URL that can be used as browser source
                const baseUrl = window.location.origin + window.location.pathname.replace('control-panel.html', '');
                const overlayUrl = `${baseUrl}overlay.html`;
                document.getElementById('overlayUrl').value = overlayUrl;
            },

            copyOverlayUrl() {
                const urlInput = document.getElementById('overlayUrl');
                urlInput.select();
                document.execCommand('copy');

                // Show feedback
                const btn = event.target.closest('.btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úì Copied!';
                btn.style.background = '#10B981';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            },

            testAlert() {
                // Show preview in a popup window
                const config = this.alertConfig;
                const testWindow = window.open('', 'Alert Preview', 'width=800,height=200');

                testWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            body {
                                margin: 0;
                                padding: 0;
                                background: transparent;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                height: 100vh;
                            }
                            .alert {
                                font-size: 36px;
                                font-weight: bold;
                                color: ${config.color};
                                text-align: center;
                                padding: 20px;
                                background: rgba(0, 0, 0, 0.8);
                                border-radius: 12px;
                                animation: ${config.animation} ${config.duration}s ease-in-out;
                            }
                            @keyframes fade {
                                0%, 100% { opacity: 0; }
                                10%, 90% { opacity: 1; }
                            }
                            @keyframes slide {
                                0% { transform: translateX(-100%); }
                                10%, 90% { transform: translateX(0); }
                                100% { transform: translateX(100%); }
                            }
                            @keyframes bounce {
                                0%, 100% { transform: translateY(-100%); opacity: 0; }
                                10% { transform: translateY(0); opacity: 1; }
                                90% { transform: translateY(0); opacity: 1; }
                            }
                            @keyframes zoom {
                                0%, 100% { transform: scale(0); opacity: 0; }
                                10%, 90% { transform: scale(1); opacity: 1; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="alert">
                            ${config.text.replace('{username}', 'TestUser123').replace('{amount}', '$5.00').replace('{message}', 'Great stream!')}
                        </div>
                        ${config.soundUrl ? `<audio autoplay><source src="${config.soundUrl}"></audio>` : ''}
                    </body>
                    </html>
                `);

                // Auto-close after duration
                setTimeout(() => {
                    testWindow.close();
                }, (config.duration + 0.5) * 1000);
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            panelManager.init();
            controlPanel.init();
            chatManager.init();

            // Show/hide scanner button based on config
            if (window.ScannerConfig && window.ScannerConfig.ENABLED && window.ScannerConfig.SHOW_IN_CONTROL_PANEL) {
                const scannerBtn = document.getElementById('scannerButtonContainer');
                if (scannerBtn) {
                    scannerBtn.style.display = 'block';
                }
            }
            overlayManager.init();
        });
    </script>
</body>
</html>
